# CitrusLink 智橘云控系统 - 使用说明

## 📁 项目文件说明

### 核心文件
- **main.py** - FastAPI 主应用，包含所有 API 接口
- **database_setup.py** - 数据库模型定义和表结构创建
- **01.html** - 前端单页应用（仪表盘界面）

### 辅助脚本
- **populate_data.py** - 测试数据填充脚本
- **view_data.py** - 数据验证查看脚本
- **init_all.py** - 一键初始化脚本（推荐使用）
- **test_connection.py** - 环境测试脚本

### 配置文件
- **requirements.txt** - Python 依赖包列表
- **setup_and_run.sh** - 自动化部署脚本（需要 sudo 权限）

### 文档
- **README.md** - 详细技术文档
- **QUICKSTART.md** - 快速启动指南
- **使用说明.md** - 本文件

---

## 🎯 系统功能

### 前端功能
1. **数字孪生监控** - 实时显示机器人和果实位置
2. **协同任务调度** - 查看任务列表和执行状态
3. **系统状态面板** - 显示在线设备数、任务进度、电量统计

### 后端 API
1. `GET /api/dashboard/stats` - 获取系统统计数据
2. `GET /api/tasks` - 获取任务列表
3. `GET /api/map/objects` - 获取地图对象（机器人和果实）

---

## 🚀 启动步骤（3 步走）

### 第 1 步：安装依赖

```bash
cd /home/anders/citrus_web_backend
pip3 install -r requirements.txt
```

**依赖包说明：**
- fastapi - Web 框架
- uvicorn - ASGI 服务器
- sqlalchemy - ORM（对象关系映射）
- geoalchemy2 - PostGIS 地理数据支持
- psycopg2-binary - PostgreSQL 数据库驱动

### 第 2 步：配置数据库

**方式 A：使用自动脚本（推荐）**
```bash
./setup_and_run.sh
```

**方式 B：手动配置**
```bash
# 确保 PostgreSQL 已启动
sudo systemctl start postgresql

# 创建数据库和用户
sudo -u postgres psql << EOF
CREATE DATABASE citrus_link;
CREATE USER admin WITH PASSWORD 'citrus_pass';
GRANT ALL PRIVILEGES ON DATABASE citrus_link TO admin;
\c citrus_link
CREATE EXTENSION postgis;
EOF
```

### 第 3 步：初始化数据

**使用一键脚本：**
```bash
python3 init_all.py
```

这个脚本会自动完成：
1. 创建数据库表结构
2. 填充测试数据
3. 验证数据正确性

**或者分步执行：**
```bash
python3 database_setup.py   # 创建表结构
python3 populate_data.py    # 填充测试数据
python3 view_data.py        # 查看数据
```

---

## 🌐 启动服务器

```bash
python3 main.py
```

启动成功后会显示：
```
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     Application startup complete.
```

然后在浏览器访问：**http://localhost:8000**

---

## 📊 数据库结构

系统包含 5 个核心表：

### 1. t_sys_user (系统用户表)
- 存储管理员账号信息
- 测试数据：admin 用户

### 2. t_sys_robot (智能终端表)
- 存储机器人状态信息
- 字段：ID、IP地址、电量、负载、状态、心跳时间
- 测试数据：UGV-01 机器人

### 3. t_biz_target (作业目标表)
- 存储果实信息（使用 PostGIS 地理坐标）
- 字段：坐标(POINTZ)、成熟度(0-1)、区域编码、图片URL
- 测试数据：Area-A 区域的一个果实

### 4. t_biz_task (作业任务表)
- 存储采摘任务信息
- 字段：优先级、状态、类型、创建时间、分配机器人
- 测试数据：一个进行中的采摘任务

### 5. t_sys_log (运行日志表)
- 存储系统日志
- 字段：机器人ID、日志内容、级别、时间
- 测试数据：系统初始化日志

---

## 🔧 常用操作

### 查看当前数据
```bash
python3 view_data.py
```

### 重置数据库
```bash
python3 database_setup.py  # 清空并重建表
python3 populate_data.py   # 重新填充测试数据
```

### 测试系统环境
```bash
python3 test_connection.py
```

### 修改数据库配置
编辑 `database_setup.py` 第 9 行：
```python
DATABASE_URL = "postgresql://用户名:密码@主机:端口/数据库名"
```

### 修改服务器端口
编辑 `main.py` 最后一行：
```python
uvicorn.run(app, host="0.0.0.0", port=8000)  # 修改端口号
```

---

## 🐛 故障排查

### 问题 1：依赖安装失败

**现象：** `pip3 install` 报错

**解决：**
```bash
pip3 install --upgrade pip
pip3 install -r requirements.txt --no-cache-dir
```

### 问题 2：数据库连接失败

**现象：** `could not connect to server`

**解决：**
```bash
# 检查服务状态
sudo systemctl status postgresql

# 启动服务
sudo systemctl start postgresql

# 测试连接
psql -U admin -d citrus_link -h localhost
```

### 问题 3：PostGIS 扩展错误

**现象：** `type "geometry" does not exist`

**解决：**
```bash
sudo apt install postgis postgresql-14-postgis-3
sudo -u postgres psql -d citrus_link -c "CREATE EXTENSION IF NOT EXISTS postgis;"
```

### 问题 4：权限错误

**现象：** `permission denied for database`

**解决：**
```bash
sudo -u postgres psql << EOF
GRANT ALL PRIVILEGES ON DATABASE citrus_link TO admin;
\c citrus_link
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO admin;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO admin;
EOF
```

### 问题 5：端口被占用

**现象：** `Address already in use`

**解决：**
```bash
# 查找占用进程
sudo lsof -i :8000

# 终止进程
kill -9 <进程ID>
```

---

## 💡 使用技巧

### 1. 自动刷新
前端页面每 5 秒自动刷新地图数据，无需手动操作。

### 2. 查看 API 文档
访问 http://localhost:8000/docs 可查看自动生成的 API 文档（Swagger UI）。

### 3. 调试模式
在 `main.py` 中设置 `debug=True`：
```python
app = FastAPI(debug=True)
```

### 4. 添加更多测试数据
编辑 `populate_data.py`，添加更多机器人、任务等数据。

---

## 📈 系统监控

### 实时监控指标
- **在线设备数**：显示当前在线的机器人数量
- **任务完成率**：已完成任务占总任务的百分比
- **平均电量**：所有机器人的平均电池电量

### 地图显示
- 🤖 蓝色方块：机器人位置
- 🍊 橙子图标：果实位置（从 PostGIS 坐标读取）

---

## 🔐 安全建议

如果要部署到生产环境：

1. **修改默认密码**
   ```bash
   # 修改 database_setup.py 中的 DATABASE_URL
   DATABASE_URL = "postgresql://新用户名:强密码@主机:端口/数据库名"
   ```

2. **配置 CORS 白名单**
   ```python
   # 在 main.py 中限制允许的域名
   app.add_middleware(
       CORSMiddleware,
       allow_origins=["https://yourdomain.com"],  # 只允许特定域名
       ...
   )
   ```

3. **使用 HTTPS**
   - 配置 Nginx 反向代理
   - 申请 SSL 证书

4. **数据库备份**
   ```bash
   pg_dump -U admin citrus_link > backup.sql
   ```

---

## 📞 技术支持

遇到问题请查看：
1. README.md - 详细技术文档
2. QUICKSTART.md - 快速启动指南
3. 运行 `python3 test_connection.py` 诊断环境

---

## 🎓 学习资源

- FastAPI 文档: https://fastapi.tiangolo.com/
- SQLAlchemy 文档: https://docs.sqlalchemy.org/
- PostGIS 文档: https://postgis.net/docs/
- PostgreSQL 文档: https://www.postgresql.org/docs/

---

**祝使用愉快！** 🎉
